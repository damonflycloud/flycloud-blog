<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/flyCloud.css?v=5.1.0"/


  <meta name="keywords" content="spring," />








  <link rel="shortcut icon" type="image/x-icon" href="http://7xowny.com1.z0.glb.clouddn.com/flycloud.ico?v=5.1.0" />






<meta name="description" content="最近几天跟同事聊起Spring的一些问题，对一些地方有些疑问，趁这两天有点空，看看Spring的源码，了解下具体的实现细节。本文基于Spring 4.3.9版本。 此篇文章最关键类为:XmlWebApplicationContext,下面将XmlWebApplicationContext的类图供大家参考一下. 首先Web项目使用Spring是通过在web.xml里面配置org.springfram">
<meta name="keywords" content="spring">
<meta property="og:type" content="article">
<meta property="og:title" content="看看Spring的源码 (一)——Bean加载过程">
<meta property="og:url" content="flycloud.me/2017/09/13/spring源码/spring/看看Spring的源码 (一)——Bean加载过程/index.html">
<meta property="og:site_name" content="FlyCloud Blog">
<meta property="og:description" content="最近几天跟同事聊起Spring的一些问题，对一些地方有些疑问，趁这两天有点空，看看Spring的源码，了解下具体的实现细节。本文基于Spring 4.3.9版本。 此篇文章最关键类为:XmlWebApplicationContext,下面将XmlWebApplicationContext的类图供大家参考一下. 首先Web项目使用Spring是通过在web.xml里面配置org.springfram">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="/images/spring源码/spring/XmlWebApplicationContext.png">
<meta property="og:updated_time" content="2017-09-26T07:19:04.742Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="看看Spring的源码 (一)——Bean加载过程">
<meta name="twitter:description" content="最近几天跟同事聊起Spring的一些问题，对一些地方有些疑问，趁这两天有点空，看看Spring的源码，了解下具体的实现细节。本文基于Spring 4.3.9版本。 此篇文章最关键类为:XmlWebApplicationContext,下面将XmlWebApplicationContext的类图供大家参考一下. 首先Web项目使用Spring是通过在web.xml里面配置org.springfram">
<meta name="twitter:image" content="/images/spring源码/spring/XmlWebApplicationContext.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":0,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="flycloud.me/2017/09/13/spring源码/spring/看看Spring的源码 (一)——Bean加载过程/"/>





  <title> 看看Spring的源码 (一)——Bean加载过程 | FlyCloud Blog </title>
</head>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?060f8b2450825fadd6aff6e494ce6218";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="flycloud.me/2017/09/13/spring源码/spring/看看Spring的源码 (一)——Bean加载过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="flycloud">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xowny.com1.z0.glb.clouddn.com/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FlyCloud Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                看看Spring的源码 (一)——Bean加载过程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-13T11:33:50+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
            <span class="page-pv">热度
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>℃
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近几天跟同事聊起Spring的一些问题，对一些地方有些疑问，趁这两天有点空，看看Spring的源码，了解下具体的实现细节。本文基于Spring 4.3.9版本。</p>
<p>此篇文章最关键类为:XmlWebApplicationContext,下面将<code>XmlWebApplicationContext</code>的类图供大家参考一下.<img src="/images/spring源码/spring/XmlWebApplicationContext.png" alt="XmlWebApplicationContext"></p>
<p>首先Web项目使用Spring是通过在web.xml里面配置<br><code>org.springframework.web.context.ContextLoaderListener</code>初始化IOC容器的。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>那就以此为切入点顺藤摸瓜。</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextLoaderListener</span> <span class="keyword">extends</span> <span class="title">ContextLoader</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span></span></div></pre></td></tr></table></figure>
<p><code>ContextLoaderListener</code>继承了<code>ContextLoader</code>，并且实现<code>ServletContextListener</code>接口。当Server容器（一般指tomcat）启动时，会收到事件初始化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;</div><div class="line">	initWebApplicationContext(event.getServletContext());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>initWebApplicationContext</code>方法是在<code>org.springframework.web.context.ContextLoader</code>类里面。方法太长，分段读一下。</p>
<p>首先是判断<code>servletContext</code>中是否已经注册了<code>WebApplicationContext</code>，如果有则抛出异常，避免重复注册。然后就是启用log，启动计时。本方法的关键就在于try代码块里的内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Initialize Spring's web application context for the given servlet context,</div><div class="line"> * using the application context provided at construction time, or creating a new one</div><div class="line"> * according to the "&#123;<span class="doctag">@link</span> #CONTEXT_CLASS_PARAM contextClass&#125;" and</div><div class="line"> * "&#123;<span class="doctag">@link</span> #CONFIG_LOCATION_PARAM contextConfigLocation&#125;" context-params.</div><div class="line"> * <span class="doctag">@param</span> servletContext current servlet context</div><div class="line"> * <span class="doctag">@return</span> the new WebApplicationContext</div><div class="line"> * <span class="doctag">@see</span> #ContextLoader(WebApplicationContext)</div><div class="line"> * <span class="doctag">@see</span> #CONTEXT_CLASS_PARAM</div><div class="line"> * <span class="doctag">@see</span> #CONFIG_LOCATION_PARAM</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> WebApplicationContext <span class="title">initWebApplicationContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</div><div class="line">	<span class="comment">// 检查ServletContext是否已经有了根容器</span></div><div class="line">	<span class="keyword">if</span> (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">				<span class="string">"Cannot initialize context because there is already a root application context present - "</span> +</div><div class="line">				<span class="string">"check whether you have multiple ContextLoader* definitions in your web.xml!"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Log logger = LogFactory.getLog(ContextLoader.class);</div><div class="line">	servletContext.log(<span class="string">"Initializing Spring root WebApplicationContext"</span>);</div><div class="line">	<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">		logger.info(<span class="string">"Root WebApplicationContext: initialization started"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">long</span> startTime = System.currentTimeMillis();</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// Store context in local instance variable, to guarantee that</span></div><div class="line">		<span class="comment">// it is available on ServletContext shutdown.</span></div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.context == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 创建spring容器，据contextClass初始化参数指定或者使用默认的XmlWebApplicationContext类</span></div><div class="line">			<span class="keyword">this</span>.context = createWebApplicationContext(servletContext);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.context <span class="keyword">instanceof</span> ConfigurableWebApplicationContext) &#123;</div><div class="line">			ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) <span class="keyword">this</span>.context;</div><div class="line">			<span class="keyword">if</span> (!cwac.isActive()) &#123;</div><div class="line">				<span class="comment">// The context has not yet been refreshed -&gt; provide services such as</span></div><div class="line">				<span class="comment">// 如果容器没有被刷新，执行以下操作</span></div><div class="line">				<span class="comment">// setting the parent context, setting the application context id, etc</span></div><div class="line">				<span class="keyword">if</span> (cwac.getParent() == <span class="keyword">null</span>) &#123;</div><div class="line">					<span class="comment">// The context instance was injected without an explicit parent -&gt;</span></div><div class="line">					<span class="comment">// determine parent for root web application context, if any.</span></div><div class="line">					<span class="comment">// 加载父容器。</span></div><div class="line">					<span class="comment">// 通过locatorFactorySelector上下文初始化参数指定父容器所在的配置文件路径</span></div><div class="line">					<span class="comment">// 通过parentContextKey上下文初始化参数指定父容器的名称,如果没有配置parentContextKey,则父容器为null</span></div><div class="line">					<span class="comment">//针对普通web应用,根本不需要设置,也就是为空</span></div><div class="line">					ApplicationContext parent = loadParentContext(servletContext);</div><div class="line">					cwac.setParent(parent);</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 配置并执行容器刷新操作</span></div><div class="line">				configureAndRefreshWebApplicationContext(cwac, servletContext);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 把spring容器加入到ServletContext中作为根容器</span></div><div class="line">		servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="keyword">this</span>.context);</div><div class="line"></div><div class="line">		ClassLoader ccl = Thread.currentThread().getContextClassLoader();</div><div class="line">		<span class="keyword">if</span> (ccl == ContextLoader.class.getClassLoader()) &#123;</div><div class="line">			currentContext = <span class="keyword">this</span>.context;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ccl != <span class="keyword">null</span>) &#123;</div><div class="line">			currentContextPerThread.put(ccl, <span class="keyword">this</span>.context);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">			logger.debug(<span class="string">"Published root WebApplicationContext as ServletContext attribute with name ["</span> +</div><div class="line">					WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE + <span class="string">"]"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">			<span class="keyword">long</span> elapsedTime = System.currentTimeMillis() - startTime;</div><div class="line">			logger.info(<span class="string">"Root WebApplicationContext: initialization completed in "</span> + elapsedTime + <span class="string">" ms"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.context;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">		logger.error(<span class="string">"Context initialization failed"</span>, ex);</div><div class="line">		servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);</div><div class="line">		<span class="keyword">throw</span> ex;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Error err) &#123;</div><div class="line">		logger.error(<span class="string">"Context initialization failed"</span>, err);</div><div class="line">		servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, err);</div><div class="line">		<span class="keyword">throw</span> err;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里面有几个关键的方法。首先看一下<code>createWebApplicationContext()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> WebApplicationContext <span class="title">createWebApplicationContext</span><span class="params">(ServletContext sc)</span> </span>&#123;</div><div class="line">    Class&lt;?&gt; contextClass = determineContextClass(sc);</div><div class="line">    <span class="keyword">if</span> (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Custom context class ["</span> + contextClass.getName() +</div><div class="line">                <span class="string">"] is not of type ["</span> + ConfigurableWebApplicationContext.class.getName() + <span class="string">"]"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Return the WebApplicationContext implementation class to use, either the</div><div class="line"> * default XmlWebApplicationContext or a custom context class if specified.</div><div class="line"> * <span class="doctag">@param</span> servletContext current servlet context</div><div class="line"> * <span class="doctag">@return</span> the WebApplicationContext implementation class to use</div><div class="line"> * <span class="doctag">@see</span> #CONTEXT_CLASS_PARAM</div><div class="line"> * <span class="doctag">@see</span> org.springframework.web.context.support.XmlWebApplicationContext</div><div class="line"> */</div><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; determineContextClass(ServletContext servletContext) &#123;</div><div class="line">	<span class="comment">//声明public static final String CONTEXT_CLASS_PARAM = "contextClass";</span></div><div class="line">	String contextClassName = servletContext.getInitParameter(CONTEXT_CLASS_PARAM);</div><div class="line">	<span class="keyword">if</span> (contextClassName != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">return</span> ClassUtils.forName(contextClassName, ClassUtils.getDefaultClassLoader());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</div><div class="line">					<span class="string">"Failed to load custom context class ["</span> + contextClassName + <span class="string">"]"</span>, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		contextClassName = defaultStrategies.getProperty(WebApplicationContext.class.getName());</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">return</span> ClassUtils.forName(contextClassName, ContextLoader.class.getClassLoader());</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</div><div class="line">					<span class="string">"Failed to load default context class ["</span> + contextClassName + <span class="string">"]"</span>, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先<code>determineContextClass()</code>方法查明具体的<code>Context</code>类，他会读取<code>servletContext</code>的初始化参数<code>contextClass</code>，此参数我们一半不配置，所以<code>Spring</code>就会读取跟<code>org.springframework.web.context.WebApplicationContext</code>同一个包下面的<code>ContextLoader.properties</code>文件读取默认设置，反射出<code>org.springframework.web.context.support.XmlWebApplicationContext</code>类来。接下来就是在<code>configureAndRefreshWebApplicationContext()</code>方法里将新创建的<code>XmlWebApplicationContext</code>进行初始化。首先会设置一个默认ID，即<code>org.springframework.web.context.WebApplicationContext:</code>+你项目的<code>ContextPath</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureAndRefreshWebApplicationContext</span><span class="params">(ConfigurableWebApplicationContext wac, ServletContext sc)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123;</div><div class="line">		<span class="comment">// The application context id is still set to its original default value</span></div><div class="line">		<span class="comment">// -&gt; assign a more useful id based on available information</span></div><div class="line">		<span class="comment">// 为容器设置一个有用的ID</span></div><div class="line">		<span class="comment">// 声明：public static final String CONTEXT_ID_PARAM = "contextId";</span></div><div class="line">		String idParam = sc.getInitParameter(CONTEXT_ID_PARAM);</div><div class="line">		<span class="keyword">if</span> (idParam != <span class="keyword">null</span>) &#123;</div><div class="line">			wac.setId(idParam);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// Generate default id...</span></div><div class="line">			wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX +</div><div class="line">					ObjectUtils.getDisplayString(sc.getContextPath()));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//将ServletContext设置成XmlWebApplicationContext的属性，这样Spring就能在上下文里轻松拿到ServletContext</span></div><div class="line">	wac.setServletContext(sc);</div><div class="line">	<span class="comment">// 设置容器要加载的配置文件所在的路径</span></div><div class="line">	<span class="comment">// 通过contextConfigLocation上下文参数指定配置文件路径</span></div><div class="line">	<span class="comment">// 声明：public static final String CONFIG_LOCATION_PARAM = "contextConfigLocation";</span></div><div class="line">	String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM);</div><div class="line">	<span class="keyword">if</span> (configLocationParam != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">//如果没有配置,则从XmlWebApplicationContext的getDefaultConfigLocations获取默认配置文件</span></div><div class="line">		wac.setConfigLocation(configLocationParam);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// The wac environment's #initPropertySources will be called in any case when the context</span></div><div class="line">	<span class="comment">// is refreshed; do it eagerly here to ensure servlet property sources are in place for</span></div><div class="line">	<span class="comment">// use in any post-processing or initialization that occurs below prior to #refresh</span></div><div class="line">	ConfigurableEnvironment env = wac.getEnvironment();</div><div class="line">	<span class="keyword">if</span> (env <span class="keyword">instanceof</span> ConfigurableWebEnvironment) &#123;</div><div class="line">		((ConfigurableWebEnvironment) env).initPropertySources(sc, <span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 在容器刷新前，自定义容器。</span></div><div class="line">	<span class="comment">// 执行用户通过globalInitializerClasses,contextInitializerClasses上下文参数指定的容器初始化器</span></div><div class="line">	customizeContext(sc, wac);</div><div class="line"></div><div class="line">	<span class="comment">// 刷新容器</span></div><div class="line">	wac.refresh();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>紧接着就是将<code>ServletContext</code>设置成<code>XmlWebApplicationContext</code>的属性，这样<code>Spring</code>就能在上下文里轻松拿到<code>ServletContext</code>了。接下来就是读取<code>web.xml</code>文件中的<code>contextConfigLocation</code>参数。从<code>XmlWebApplicationContext</code>的<code>getDefaultConfigLocations</code>方法中可以看出,如果没有配置就会去读<code>WEB-INF下的applicationContext.xml</code>文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/** Default config location for the root context */</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CONFIG_LOCATION = <span class="string">"/WEB-INF/applicationContext.xml"</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * The default location for the root context is "/WEB-INF/applicationContext.xml",</div><div class="line"> * and "/WEB-INF/test-servlet.xml" for a context with the namespace "test-servlet"</div><div class="line"> * (like for a DispatcherServlet instance with the servlet-name "test").</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">protected</span> String[] getDefaultConfigLocations() &#123;</div><div class="line">	<span class="keyword">if</span> (getNamespace() != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;DEFAULT_CONFIG_LOCATION_PREFIX + getNamespace() + DEFAULT_CONFIG_LOCATION_SUFFIX&#125;;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;DEFAULT_CONFIG_LOCATION&#125;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是读取指定配置文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:beans.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div></pre></td></tr></table></figure>
<p>并将值设置(就是我们的Spring配置文件的路径)进<code>XmlWebApplicationContext</code>中。然后就会在指定的路径加载配置文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM);</div><div class="line"><span class="keyword">if</span> (configLocationParam != <span class="keyword">null</span>) &#123;</div><div class="line">    wac.setConfigLocation(configLocationParam);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来就是<code>customizeContext(sc, wac)</code>方法，此方法会根据用户配置的<code>globalInitializerClasses和contextInitializerClasses</code>参数来初始化一些用户自定义的属性，一般我们不配置，所以这里什么也不做。</p>
<p>最后登场的就是最核心的方法了，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wac.refresh();</div></pre></td></tr></table></figure></p>
<p>在这个方法里，会完成资源文件的加载、配置文件解析、Bean定义的注册、组件的初始化等核心工作，我们一探究竟。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</div><div class="line">        <span class="comment">// Prepare this context for refreshing.</span></div><div class="line">        prepareRefresh();</div><div class="line"></div><div class="line">        <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></div><div class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</div><div class="line"></div><div class="line">        <span class="comment">// Prepare the bean factory for use in this context.</span></div><div class="line">        prepareBeanFactory(beanFactory);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></div><div class="line">            postProcessBeanFactory(beanFactory);</div><div class="line"></div><div class="line">            <span class="comment">// Invoke factory processors registered as beans in the context.</span></div><div class="line">            invokeBeanFactoryPostProcessors(beanFactory);</div><div class="line"></div><div class="line">            <span class="comment">// Register bean processors that intercept bean creation.</span></div><div class="line">            registerBeanPostProcessors(beanFactory);</div><div class="line"></div><div class="line">            <span class="comment">// Initialize message source for this context.</span></div><div class="line">            initMessageSource();</div><div class="line"></div><div class="line">            <span class="comment">// Initialize event multicaster for this context.</span></div><div class="line">            initApplicationEventMulticaster();</div><div class="line"></div><div class="line">            <span class="comment">// Initialize other special beans in specific context subclasses.</span></div><div class="line">            onRefresh();</div><div class="line"></div><div class="line">            <span class="comment">// Check for listener beans and register them.</span></div><div class="line">            registerListeners();</div><div class="line"></div><div class="line">            <span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></div><div class="line">            finishBeanFactoryInitialization(beanFactory);</div><div class="line"></div><div class="line">            <span class="comment">// Last step: publish corresponding event.</span></div><div class="line">            finishRefresh();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">            <span class="comment">// Destroy already created singletons to avoid dangling resources.</span></div><div class="line">            destroyBeans();</div><div class="line"></div><div class="line">            <span class="comment">// Reset 'active' flag.</span></div><div class="line">            cancelRefresh(ex);</div><div class="line"></div><div class="line">            <span class="comment">// Propagate exception to caller.</span></div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>次方法是同步的，避免重复刷新，每个步骤都放在单独的方法内，流程清晰，是值得学习的地方。这里面有个重要的方法是<code>finishBeanFactoryInitialization(beanFactory);</code>，里面的内容是Spring如何实例化bean，并注入依赖的，这个内容下一节讲，本节只说明Spring是如何加载class文件的。</p>
<p>首先就是<code>prepareRefresh()</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Prepare this context for refreshing, setting its startup date and</div><div class="line"> * active flag as well as performing any initialization of property sources.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>.startupDate = System.currentTimeMillis();</div><div class="line">	<span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">		logger.info(<span class="string">"Refreshing "</span> + <span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Initialize any placeholder property sources in the context environment</span></div><div class="line">	initPropertySources();</div><div class="line"></div><div class="line">	<span class="comment">// Validate that all properties marked as required are resolvable</span></div><div class="line">	<span class="comment">// see ConfigurablePropertyResolver#setRequiredProperties</span></div><div class="line">	getEnvironment().validateRequiredProperties();</div><div class="line"></div><div class="line">	<span class="comment">// Allow for the collection of early ApplicationEvents,</span></div><div class="line">	<span class="comment">// to be published once the multicaster is available...</span></div><div class="line">	<span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;ApplicationEvent&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此方法做一些准备工作，如记录开始时间，输出日志，<code>initPropertySources();</code>和<code>getEnvironment().validateRequiredProperties();</code>一般没干什么事。</p>
<p>接下来就是初始化<code>BeanFactory</code>，是整个<code>refresh()</code>方法的核心，其中完成了配置文件的加载、解析、注册<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</div></pre></td></tr></table></figure></p>
<p>看看它里面都做了些什么？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Tell the subclass to refresh the internal bean factory.</div><div class="line"> * <span class="doctag">@return</span> the fresh BeanFactory instance</div><div class="line"> * <span class="doctag">@see</span> #refreshBeanFactory()</div><div class="line"> * <span class="doctag">@see</span> #getBeanFactory()</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">	refreshBeanFactory();</div><div class="line">	ConfigurableListableBeanFactory beanFactory = getBeanFactory();</div><div class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">		logger.debug(<span class="string">"Bean factory for "</span> + getDisplayName() + <span class="string">": "</span> + beanFactory);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> beanFactory;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先<code>refreshBeanFactory()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This implementation performs an actual refresh of this context's underlying</div><div class="line"> * bean factory, shutting down the previous bean factory (if any) and</div><div class="line"> * initializing a fresh bean factory for the next phase of the context's lifecycle.</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">	<span class="keyword">if</span> (hasBeanFactory()) &#123;</div><div class="line">		destroyBeans();</div><div class="line">		closeBeanFactory();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		DefaultListableBeanFactory beanFactory = createBeanFactory();</div><div class="line">		beanFactory.setSerializationId(getId());</div><div class="line">		customizeBeanFactory(beanFactory);</div><div class="line">		loadBeanDefinitions(beanFactory);</div><div class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</div><div class="line">			<span class="keyword">this</span>.beanFactory = beanFactory;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们看到会创建一个<code>DefaultListableBeanFactory</code>实例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DefaultListableBeanFactory beanFactory = createBeanFactory();</div></pre></td></tr></table></figure></p>
<p>再设置一个ID<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">beanFactory.setSerializationId(getId());</div></pre></td></tr></table></figure></p>
<p>然后设置一些自定义参数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">customizeBeanFactory(beanFactory);</div></pre></td></tr></table></figure></p>
<p>这里面最重要的就是<code>loadBeanDefinitions(beanFactory);</code>方法了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Loads the bean definitions via an XmlBeanDefinitionReader.</div><div class="line"> * <span class="doctag">@see</span> org.springframework.beans.factory.xml.XmlBeanDefinitionReader</div><div class="line"> * <span class="doctag">@see</span> #initBeanDefinitionReader</div><div class="line"> * <span class="doctag">@see</span> #loadBeanDefinitions</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</div><div class="line">	<span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></div><div class="line">	XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</div><div class="line"></div><div class="line">	<span class="comment">// Configure the bean definition reader with this context's</span></div><div class="line">	<span class="comment">// resource loading environment.</span></div><div class="line">	beanDefinitionReader.setEnvironment(getEnvironment());</div><div class="line">	beanDefinitionReader.setResourceLoader(<span class="keyword">this</span>);</div><div class="line">	beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> ResourceEntityResolver(<span class="keyword">this</span>));</div><div class="line"></div><div class="line">	<span class="comment">// Allow a subclass to provide custom initialization of the reader,</span></div><div class="line">	<span class="comment">// then proceed with actually loading the bean definitions.</span></div><div class="line">	initBeanDefinitionReader(beanDefinitionReader);</div><div class="line">	loadBeanDefinitions(beanDefinitionReader);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们来看一下核心部分loadBeanDefinitions(beanDefinitionReader);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Load the bean definitions with the given XmlBeanDefinitionReader.</div><div class="line"> * &lt;p&gt;The lifecycle of the bean factory is handled by the refreshBeanFactory method;</div><div class="line"> * therefore this method is just supposed to load and/or register bean definitions.</div><div class="line"> * &lt;p&gt;Delegates to a ResourcePatternResolver for resolving location patterns</div><div class="line"> * into Resource instances.</div><div class="line"> * <span class="doctag">@throws</span> IOException if the required XML document isn't found</div><div class="line"> * <span class="doctag">@see</span> #refreshBeanFactory</div><div class="line"> * <span class="doctag">@see</span> #getConfigLocations</div><div class="line"> * <span class="doctag">@see</span> #getResources</div><div class="line"> * <span class="doctag">@see</span> #getResourcePatternResolver</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	String[] configLocations = getConfigLocations();</div><div class="line">	<span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">for</span> (String configLocation : configLocations) &#123;</div><div class="line">			reader.loadBeanDefinitions(configLocation);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此方法会通过<code>XmlBeanDefinitionReader</code>加载bean定义。具体的实现方法是在<code>org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions</code>方法中定义的。<br>这里设计了层层调用，有好多重载方法，主要就是加载Spring所有的配置文件(可能会有多个)，以备后面解析，注册之用。<br>由 <code>reader.loadBeanDefinitions(configLocation)</code>可以跳转到<code>AbstractBeanDefinitionReader.loadBeanDefinitions(configLocation)</code>,将<code>location</code>解析成对应<code>Resource</code>对象,而用来解析的功能即使用<code>getResourceLoader()</code>返回的<code>ResourceLoader</code>对象来完成(在<code>AbstractBeanDefinitionReader</code>中即为<code>PathMatchingResourcePatternResolver</code>).<br><code>loadBeanDefinitions(Resource resource</code>)方法是在<code>XmlBeanDefinitionReader</code>类中来实现的</p>
<p>我一路追踪到<code>org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader.doRegisterBeanDefinitions(Element root)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Register each bean definition within the given root &#123;<span class="doctag">@code</span> &lt;beans/&gt;&#125; element.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</div><div class="line">	<span class="comment">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span></div><div class="line">	<span class="comment">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span></div><div class="line">	<span class="comment">// keep track of the current (parent) delegate, which may be null. Create</span></div><div class="line">	<span class="comment">// the new (child) delegate with a reference to the parent for fallback purposes,</span></div><div class="line">	<span class="comment">// then ultimately reset this.delegate back to its original (parent) reference.</span></div><div class="line">	<span class="comment">// this behavior emulates a stack of delegates without actually necessitating one.</span></div><div class="line">	<span class="comment">//在DefaultBeanDefinitionDocumentReader处理Document元素时,将Document文档内元素具体解析工作委托给BeanDefinitionParserDelegate类来处理,</span></div><div class="line">	<span class="comment">//默认BeanDefinitionParserDelegate会处理”http://www.springframework.org/schema/beans“命名空间下元素及其属性</span></div><div class="line">	BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</div><div class="line">	<span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.delegate.isDefaultNamespace(root)) &#123;</div><div class="line">		String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</div><div class="line">		<span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</div><div class="line">			String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</div><div class="line">					profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</div><div class="line">			<span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</div><div class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">					logger.info(<span class="string">"Skipped XML bean definition file due to specified profiles ["</span> + profileSpec +</div><div class="line">							<span class="string">"] not matching: "</span> + getReaderContext().getResource());</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	preProcessXml(root);</div><div class="line">	parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</div><div class="line">	postProcessXml(root);</div><div class="line"></div><div class="line">	<span class="keyword">this</span>.delegate = parent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里创建了一个<code>BeanDefinitionParserDelegate</code>示例，解析XML的过程就是委托它完成的，我们不关心它是怎样解析XML的，我们只关心是怎么加载类的，所以就要看<code>parseBeanDefinitions(root, this.delegate)</code>方法了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Parse the elements at the root level in the document:</div><div class="line"> * "import", "alias", "bean".默认命名空间</div><div class="line"> * <span class="doctag">@param</span> root the DOM root element of the document</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</div><div class="line">		NodeList nl = root.getChildNodes();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</div><div class="line">			Node node = nl.item(i);</div><div class="line">			<span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</div><div class="line">				Element ele = (Element) node;</div><div class="line">				<span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</div><div class="line">					parseDefaultElement(ele, delegate);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span> &#123;</div><div class="line">					delegate.parseCustomElement(ele);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		delegate.parseCustomElement(root);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果是<code>BEANS_NAMESPACE_URI = &quot;http://www.springframework.org/schema/beans&quot;</code>命名空间的tag,则跳转到<code>parseDefaultElement</code>方法,<br>我们看到最终解析XML元素的是<code>delegate.parseCustomElement(ele)</code>方法，最终会走到一下方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parseCustomElement</span><span class="params">(Element ele, <span class="keyword">public</span> BeanDefinition parseCustomElement(Element ele, BeanDefinition containingBd)</span> </span>&#123;</div><div class="line">	<span class="comment">//返回节点的命名空间URI,例如http://www.springframework.org/schema/context</span></div><div class="line">	<span class="comment">//语法为:xmlns:namespace-prefix="namespaceURI" ,当命名空间被定义在元素的开始标签中时，所有带有相同前缀的子元素都会与同一个命名空间相关联。</span></div><div class="line">	String namespaceUri = getNamespaceURI(ele);</div><div class="line">	<span class="comment">//根据命名空间获取对应的NamespaceHandler,例如ContextNamespaceHandler;</span></div><div class="line">	NamespaceHandler handler = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</div><div class="line">	<span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">		error(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, ele);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//使用对应的NamespaceHandler,获取解析并注册bean</span></div><div class="line">	<span class="keyword">return</span> handler.parse(ele, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里会根据不同的XML节点，会委托<code>NamespaceHandlerSupport</code>找出合适的<code>BeanDefinitionParser</code>，如果我们配置了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;context:component-scan</div><div class="line">	base-<span class="keyword">package</span>=<span class="string">"com.geeekr.service,com.geeekr.dao"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>那么对应<code>BeanDefinitionParser</code>就是<code>org.springframework.context.annotation.ComponentScanBeanDefinitionParser</code>，来看看它的<code>parse</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//解析base-package属性值，扫描的包可以,;分隔</span></div><div class="line">	String basePackage = element.getAttribute(BASE_PACKAGE_ATTRIBUTE);</div><div class="line">	basePackage = parserContext.getReaderContext().getEnvironment().resolvePlaceholders(basePackage);</div><div class="line">	String[] basePackages = StringUtils.tokenizeToStringArray(basePackage,</div><div class="line">			ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</div><div class="line"></div><div class="line">	<span class="comment">// Actually scan for bean definitions and register them.</span></div><div class="line">	ClassPathBeanDefinitionScanner scanner = configureScanner(parserContext, element);</div><div class="line">	<span class="comment">//通过ClassPathBeanDefinitionScanner扫描类来获取包名下的所有class并将他们注册到spring的bean工厂中</span></div><div class="line">	Set&lt;BeanDefinitionHolder&gt; beanDefinitions = scanner.doScan(basePackages);</div><div class="line">	<span class="comment">//注册其他注解组件</span></div><div class="line">	<span class="comment">//此处代码与AnnotationConfigBeanDefinitionParser相同,所以配置了context:component-scan节点等同于不需要配置context:annotation-config节点</span></div><div class="line">	registerComponents(parserContext.getReaderContext(), beanDefinitions, element);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不难看出这里定义了一个<code>ClassPathBeanDefinitionScanner</code>，通过它去扫描包中的类文件，<strong><em>注意：这里是类文件而不是类，因为现在这些类还没有被加载，只是ClassLoader能找到这些class的路径而已。</em></strong></p>
<p>下面展示如何创建扫描器，以及相关的初始操作:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> ClassPathBeanDefinitionScanner <span class="title">configureScanner</span><span class="params">(ParserContext parserContext, Element element)</span> </span>&#123;</div><div class="line">	<span class="comment">//默认使用spring自带的注解过滤</span></div><div class="line">	<span class="keyword">boolean</span> useDefaultFilters = <span class="keyword">true</span>;</div><div class="line">	<span class="comment">//解析`use-default-filters`，类型为boolean</span></div><div class="line">	<span class="keyword">if</span> (element.hasAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE)) &#123;</div><div class="line">		useDefaultFilters = Boolean.valueOf(element.getAttribute(USE_DEFAULT_FILTERS_ATTRIBUTE));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Delegate bean definition registration to scanner class.</span></div><div class="line">	<span class="comment">//此处如果`use-default-filters`为true，则添加`@Component`、`@Service`、`@Controller`、`@Repository`、`@ManagedBean`、`@Named`添加到includeFilters的集合过滤</span></div><div class="line">	ClassPathBeanDefinitionScanner scanner = createScanner(parserContext.getReaderContext(), useDefaultFilters);</div><div class="line">	scanner.setBeanDefinitionDefaults(parserContext.getDelegate().getBeanDefinitionDefaults());</div><div class="line">	scanner.setAutowireCandidatePatterns(parserContext.getDelegate().getAutowireCandidatePatterns());</div><div class="line"></div><div class="line">	<span class="comment">//设置`resource-pattern`属性，扫描资源的模式匹配，支持正则表达式</span></div><div class="line">	<span class="keyword">if</span> (element.hasAttribute(RESOURCE_PATTERN_ATTRIBUTE)) &#123;</div><div class="line">		scanner.setResourcePattern(element.getAttribute(RESOURCE_PATTERN_ATTRIBUTE));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">//解析name-generator属性 beanName生成器</span></div><div class="line">		parseBeanNameGenerator(element, scanner);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">		parserContext.getReaderContext().error(ex.getMessage(), parserContext.extractSource(element), ex.getCause());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">//解析scope-resolver属性和scoped-proxy属性，但两者只可存在其一</span></div><div class="line">		<span class="comment">//后者值为targetClass：cglib代理、interfaces：JDK代理、no：不使用代理</span></div><div class="line">		parseScope(element, scanner);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">		parserContext.getReaderContext().error(ex.getMessage(), parserContext.extractSource(element), ex.getCause());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//解析子节点`context:include-filter`、`context:exclude-filter`主要用于对扫描class类的过滤</span></div><div class="line">	<span class="comment">//例如&lt;context:include-filter type="annotation" expression="org.springframework.stereotype.Controller.RestController" /&gt;</span></div><div class="line">	parseTypeFilters(element, scanner, parserContext);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> scanner;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到目前为止，感觉真想距离我们越来越近了。顺着继续往下摸。进入<code>doSacn</code>方法里，映入眼帘的又是一大坨代码，但是我们只关心观点的部分。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Perform a scan within the specified base packages,</div><div class="line"> * returning the registered bean definitions.</div><div class="line"> * &lt;p&gt;This method does &lt;i&gt;not&lt;/i&gt; register an annotation config processor</div><div class="line"> * but rather leaves this up to the caller.</div><div class="line"> * <span class="doctag">@param</span> basePackages the packages to check for annotated classes</div><div class="line"> * <span class="doctag">@return</span> set of beans registered if any for tooling registration purposes (never &#123;<span class="doctag">@code</span> null&#125;)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">doScan</span><span class="params">(String... basePackages)</span> </span>&#123;</div><div class="line">	<span class="comment">//表明base-package属性是需要被指定的</span></div><div class="line">	Assert.notEmpty(basePackages, <span class="string">"At least one base package must be specified"</span>);</div><div class="line">	Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">new</span> LinkedHashSet&lt;BeanDefinitionHolder&gt;();</div><div class="line">	<span class="keyword">for</span> (String basePackage : basePackages) &#123;</div><div class="line"></div><div class="line">		<span class="comment">//对每个基础包都进行扫描寻找并且对基础包下的所有class都注册为BeanDefinition</span></div><div class="line">		<span class="comment">/**</span></div><div class="line">		 **</div><div class="line">		 **并对得到的candidates集合进行过滤，此处便用到include-filters和exclude-filters</div><div class="line">		 */</div><div class="line">		Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</div><div class="line">		<span class="keyword">for</span> (BeanDefinition candidate : candidates) &#123;</div><div class="line">			<span class="comment">//解析一个bean的scope属性，代表作用范围</span></div><div class="line">			<span class="comment">//prototype-&gt;每次请求都创建新的对象 singleton-&gt;单例模式，处理多请求</span></div><div class="line">			ScopeMetadata scopeMetadata = <span class="keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);</div><div class="line">			candidate.setScope(scopeMetadata.getScopeName());</div><div class="line">			<span class="comment">//使用beanName生成器生成</span></div><div class="line">			String beanName = <span class="keyword">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="keyword">this</span>.registry);</div><div class="line">			<span class="comment">/**</span></div><div class="line">			 **对注册的bean进行另外的赋值处理，比如默认属性的配置</div><div class="line">			 *返回的candidate类型为ScannedGenericBeanDefinition，下面两者</div><div class="line">			 *条件满足</div><div class="line">			 */</div><div class="line">			<span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</div><div class="line">				<span class="comment">//设置lazy-init/autowire-code默认属性，从spring配置的&lt;beans&gt;节点属性读取</span></div><div class="line">				postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</div><div class="line">				<span class="comment">//读取bean上的注解，比如`@Lazy`、`@Dependson`的值设置相应的属性</span></div><div class="line">				AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">//查看是否已注册</span></div><div class="line">			<span class="keyword">if</span> (checkCandidate(beanName, candidate)) &#123;</div><div class="line">				BeanDefinitionHolder definitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(candidate, beanName);</div><div class="line">				<span class="comment">//默认采取cglib来做代理</span></div><div class="line">				definitionHolder =</div><div class="line">						AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="keyword">this</span>.registry);</div><div class="line">				beanDefinitions.add(definitionHolder);</div><div class="line">				<span class="comment">//注册bean信息到工厂中</span></div><div class="line">				registerBeanDefinition(definitionHolder, <span class="keyword">this</span>.registry);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> beanDefinitions;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一眼就能看出是通过<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</div></pre></td></tr></table></figure></p>
<p>有时候不得不佩服这些外国人起名字的功力，把扫描出来的类叫做candidates(候选人)；真是不服不行啊，这种名字真的很容易理解有不有？哈哈，貌似扯远了。继续往下看。这里只列出方法的主题部分。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">	 * Scan the class path for candidate components.</div><div class="line">	 * <span class="doctag">@param</span> basePackage the package to check for annotated classes</div><div class="line">	 * <span class="doctag">@return</span> a corresponding Set of autodetected bean definitions</div><div class="line">	 */</div><div class="line"><span class="comment">//扫描包下的所有class文件并对其进行过滤，过滤的条件为includeFilters和excludeFilters集合,并实例化为BeanDefinition对象</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Set&lt;BeanDefinition&gt; <span class="title">findCandidateComponents</span><span class="params">(String basePackage)</span> </span>&#123;</div><div class="line">		Set&lt;BeanDefinition&gt; candidates = <span class="keyword">new</span> LinkedHashSet&lt;BeanDefinition&gt;();</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//值类似为classpath*:com/question/sky/**/*.class</span></div><div class="line">			String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</div><div class="line">					resolveBasePackage(basePackage) + <span class="string">'/'</span> + <span class="keyword">this</span>.resourcePattern;</div><div class="line">			<span class="comment">//通过PathMatchingResourcePatternResolver来找寻资源</span></div><div class="line">			<span class="comment">//常用的Resource为FileSystemResource</span></div><div class="line">			Resource[] resources = <span class="keyword">this</span>.resourcePatternResolver.getResources(packageSearchPath);</div><div class="line">			<span class="keyword">boolean</span> traceEnabled = logger.isTraceEnabled();</div><div class="line">			<span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</div><div class="line">			<span class="keyword">for</span> (Resource resource : resources) &#123;</div><div class="line">				<span class="keyword">if</span> (traceEnabled) &#123;</div><div class="line">					logger.trace(<span class="string">"Scanning "</span> + resource);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (resource.isReadable()) &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						<span class="comment">//生成MetadataReader对象-&gt;SimpleMetadataReader，内部包含AnnotationMetadataReadingVisitor注解访问处理类</span></div><div class="line">						MetadataReader metadataReader = <span class="keyword">this</span>.metadataReaderFactory.getMetadataReader(resource);</div><div class="line">						<span class="comment">//判断class是否不属于excludeFilters集合内但至少符合一个includeFilters集合</span></div><div class="line">						<span class="keyword">if</span> (isCandidateComponent(metadataReader)) &#123;</div><div class="line">							<span class="comment">//包装为ScannedGenericBeanDefinition对象</span></div><div class="line">							ScannedGenericBeanDefinition sbd = <span class="keyword">new</span> ScannedGenericBeanDefinition(metadataReader);</div><div class="line">							<span class="comment">//保存文件资源</span></div><div class="line">							sbd.setResource(resource);</div><div class="line">							sbd.setSource(resource);</div><div class="line">							<span class="comment">//判断class文件是否不为接口或者抽象类并且是独立的</span></div><div class="line">							<span class="keyword">if</span> (isCandidateComponent(sbd)) &#123;</div><div class="line">								<span class="keyword">if</span> (debugEnabled) &#123;</div><div class="line">									logger.debug(<span class="string">"Identified candidate component class: "</span> + resource);</div><div class="line">								&#125;</div><div class="line">								<span class="comment">//完成验证加入集合中</span></div><div class="line">								candidates.add(sbd);</div><div class="line">							&#125;</div><div class="line">							<span class="keyword">else</span> &#123;</div><div class="line">								<span class="keyword">if</span> (debugEnabled) &#123;</div><div class="line">									logger.debug(<span class="string">"Ignored because not a concrete top-level class: "</span> + resource);</div><div class="line">								&#125;</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">						<span class="keyword">else</span> &#123;</div><div class="line">							<span class="keyword">if</span> (traceEnabled) &#123;</div><div class="line">								logger.trace(<span class="string">"Ignored because not matching any filter: "</span> + resource);</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</div><div class="line">								<span class="string">"Failed to read candidate component class: "</span> + resource, ex);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span> &#123;</div><div class="line">					<span class="keyword">if</span> (traceEnabled) &#123;</div><div class="line">						logger.trace(<span class="string">"Ignored because not readable: "</span> + resource);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">"I/O failure during classpath scanning"</span>, ex);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> candidates;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>先看这两句：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + resolveBasePackage(basePackage) + <span class="string">"/"</span> + <span class="keyword">this</span>.resourcePattern;</div></pre></td></tr></table></figure></p>
<p>假设我们配置的需要扫描的包名为<code>com.geeekr.service</code>，那么<code>packageSearchPath</code>的值就是<code>classpath*:com.geeekr.service/**/*.class</code>，意思就是com.geeekr.service包(包括子包)下所有class文件；如果配置的是<code>*</code>，那么<code>packageSearchPath</code>的值就是<code>classpath*:*/**/*.class</code>。这里的表达式是Spring自己定义的。Spring会根据这种表达式找出相关的class文件。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Resource[] resources = <span class="keyword">this</span>.resourcePatternResolver.getResources(packageSearchPath);</div></pre></td></tr></table></figure></p>
<p>这一句就把相关class文件加载出来了，那我们就要看看，Spring究竟是如何把class文件找到的了。首先看看<code>resourcePatternResolver</code>的定义:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ResourcePatternResolver resourcePatternResolver = <span class="keyword">new</span> PathMatchingResourcePatternResolver();</div></pre></td></tr></table></figure></p>
<p>进入<code>getResources</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException &#123;</div><div class="line">    Assert.notNull(locationPattern, <span class="string">"Location pattern must not be null"</span>);</div><div class="line">    <span class="keyword">if</span> (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) &#123;</div><div class="line">        <span class="comment">// a class path resource (multiple resources for same name possible)</span></div><div class="line">        <span class="keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) &#123;</div><div class="line">            <span class="comment">// a class path resource pattern</span></div><div class="line">            <span class="keyword">return</span> findPathMatchingResources(locationPattern);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// all class path resources with the given name</span></div><div class="line">            <span class="keyword">return</span> findAllClassPathResources(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Only look for a pattern after a prefix here</span></div><div class="line">        <span class="comment">// (to not get fooled by a pattern symbol in a strange prefix).</span></div><div class="line">        <span class="keyword">int</span> prefixEnd = locationPattern.indexOf(<span class="string">":"</span>) + <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) &#123;</div><div class="line">            <span class="comment">// a file pattern</span></div><div class="line">            <span class="keyword">return</span> findPathMatchingResources(locationPattern);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// a single resource with the given name</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Resource[] &#123;getResourceLoader().getResource(locationPattern)&#125;;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里会先判断表达式是否以<code>classpath*:</code>开头。前面我们看到Spring已经给我们添加了这个头，这里当然符合条件了。接着会进入<code>findPathMatchingResources</code>方法。在这里又把<code>**/*.class</code>去掉了，然后在调用<code>getResources</code>方法，然后在进入<code>findAllClassPathResources</code>方法。这里的参数只剩下包名了例如<code>com/geeekr/service/</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Resource[] findAllClassPathResources(String location) <span class="keyword">throws</span> IOException &#123;</div><div class="line">    String path = location;</div><div class="line">    <span class="keyword">if</span> (path.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">        path = path.substring(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    ClassLoader cl = getClassLoader();</div><div class="line">    Enumeration&lt;URL&gt; resourceUrls = (cl != <span class="keyword">null</span> ? cl.getResources(path) : ClassLoader.getSystemResources(path));</div><div class="line">    Set&lt;Resource&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;Resource&gt;(<span class="number">16</span>);</div><div class="line">    <span class="keyword">while</span> (resourceUrls.hasMoreElements()) &#123;</div><div class="line">        URL url = resourceUrls.nextElement();</div><div class="line">        result.add(convertClassLoaderURL(url));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result.toArray(<span class="keyword">new</span> Resource[result.size()]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>真相大白了，Spring也是用的<code>ClassLoader</code>加载的class文件。一路追踪，原始的ClassLoader是<code>Thread.currentThread().getContextClassLoader();</code>。到此为止，就拿到class文件了。<br>Spring会将class信息封装成<code>BeanDefinition</code>，然后再放进<code>DefaultListableBeanFactory</code>的<code>beanDefinitionMap</code>中。</p>
<p>拿到了class文件后，就要看看Spring是如何装配bean的了，下一节，继续看。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring/" rel="tag"># spring</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/06/spring&springMvc/springMVC/Exception/" rel="next" title="Exception Handling in Spring MVC">
                <i class="fa fa-chevron-left"></i> Exception Handling in Spring MVC
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/09/13/spring源码/spring/看看Spring的源码 (二)-——bean实例化/" rel="prev" title="看看Spring的源码(二)——bean实例化">
                看看Spring的源码(二)——bean实例化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="donate-btn">作者</div>
    <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">FlyCloud Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生命在于折腾!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://7xowny.com1.z0.glb.clouddn.com/avatar.jpg"
               alt="flycloud" />
          <p class="site-author-name" itemprop="name">flycloud</p>
           
              <p class="site-description motion-element" itemprop="description">Stay Hungry,Stay Foolish</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">flycloud : Stay Hungry,Stay Foolish</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

 
  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

<a id="hamburger" class="mm-slideout" href="#mmenu"><span></span></a>

<nav id="mmenu">
     <ul>

     </ul>
 </nav>
<link type="text/css" rel="stylesheet" href="http://cdn.bootcss.com/jQuery.mmenu/5.5.3/core/css/jquery.mmenu.all.css" />
<link type="text/css" rel="stylesheet" href="http://7xowny.com1.z0.glb.clouddn.com/flyCloudMenu.css" />
<script type="text/javascript" src="http://7xowny.com1.z0.glb.clouddn.com/jquery.mmenu.min.all.js"></script>

<script type="text/javascript">
  $(function () {
          $.getJSON("/json/menu.json",function(data){
            $.each( data, function() {
            var html="<li id='" + this.id + "'>" +"<span>"+this.text + "</span></li>"
            var chirldHtml="<ul><li id='"+this.id+"'>"+"<span>"+this.text+"</span></li></ul>"
            if(this.pid==''){
                $('#mmenu>ul:first').append(html);
              }else{
              if($('li#'+this.pid+">ul").length==0){
                 $('#'+this.pid).append(chirldHtml);
              }else{
                $('li#'+this.pid+">ul").append(html);
              }
             }
            });

            
              var html="<li>" +"<a href='/2016/07/14/MBG/MyBatis配件文件详解/'>"+ " MyBatis generator 配置文件详解</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2016/07/14/MBG/MyBatis配件文件详解/'>"+" MyBatis generator 配置文件详解</a></li></ul>"
              
                   if($('li#'+"200>ul").length==0){
                    $('li#'+"200").append(chirldHtml);
                   }else{
                    $('li#'+"200>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2016/07/14/MBG/MyBatis-generator 自动生成MyBatis代码/'>"+ " MyBatis-generator 自动生成MyBatis代码</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2016/07/14/MBG/MyBatis-generator 自动生成MyBatis代码/'>"+" MyBatis-generator 自动生成MyBatis代码</a></li></ul>"
              
                   if($('li#'+"200>ul").length==0){
                    $('li#'+"200").append(chirldHtml);
                   }else{
                    $('li#'+"200>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/11/21/MBG/MyBatis-generator 分析/'>"+ " MyBatis-generator 分析</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/11/21/MBG/MyBatis-generator 分析/'>"+" MyBatis-generator 分析</a></li></ul>"
              
                   if($('li#'+"200>ul").length==0){
                    $('li#'+"200").append(chirldHtml);
                   }else{
                    $('li#'+"200>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2016/01/13/Markdown/markdown-style-guide/'>"+ " markdown style guide</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2016/01/13/Markdown/markdown-style-guide/'>"+" markdown style guide</a></li></ul>"
              
                   if($('li#'+"160>ul").length==0){
                    $('li#'+"160").append(chirldHtml);
                   }else{
                    $('li#'+"160>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/11/17/myBatis/Mybatis-spring整合/'>"+ " MyBatis spring整合</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/11/17/myBatis/Mybatis-spring整合/'>"+" MyBatis spring整合</a></li></ul>"
              
                   if($('li#'+"180>ul").length==0){
                    $('li#'+"180").append(chirldHtml);
                   }else{
                    $('li#'+"180>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/11/20/maven/mirror和repository 区别/'>"+ " Maven：mirror和repository 区别</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/11/20/maven/mirror和repository 区别/'>"+" Maven：mirror和repository 区别</a></li></ul>"
              
                   if($('li#'+"220>ul").length==0){
                    $('li#'+"220").append(chirldHtml);
                   }else{
                    $('li#'+"220>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/25/servlet/Servlet详解/'>"+ " Servlet详解</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/25/servlet/Servlet详解/'>"+" Servlet详解</a></li></ul>"
              
                   if($('li#'+"70>ul").length==0){
                    $('li#'+"70").append(chirldHtml);
                   }else{
                    $('li#'+"70>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2016/07/14/MBG/MybatisGeneator/'>"+ " MyBatis-generator 自动生成MyBatis代码</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2016/07/14/MBG/MybatisGeneator/'>"+" MyBatis-generator 自动生成MyBatis代码</a></li></ul>"
              
                   if($('li#'+"200>ul").length==0){
                    $('li#'+"200").append(chirldHtml);
                   }else{
                    $('li#'+"200>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/11/20/java/java基础/java 注解总结/'>"+ " java 注解总结</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/11/20/java/java基础/java 注解总结/'>"+" java 注解总结</a></li></ul>"
              
                   if($('li#'+"261>ul").length==0){
                    $('li#'+"261").append(chirldHtml);
                   }else{
                    $('li#'+"261>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/01/git&github/git/git远程操作详解/'>"+ " Git远程操作详解</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/01/git&github/git/git远程操作详解/'>"+" Git远程操作详解</a></li></ul>"
              
                   if($('li#'+"51>ul").length==0){
                    $('li#'+"51").append(chirldHtml);
                   }else{
                    $('li#'+"51>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/10/11/front/frontTec/前端常见跨域解决方案（全）/'>"+ " 前端常见跨域解决方案（全）</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/10/11/front/frontTec/前端常见跨域解决方案（全）/'>"+" 前端常见跨域解决方案（全）</a></li></ul>"
              
                   if($('li#'+"141>ul").length==0){
                    $('li#'+"141").append(chirldHtml);
                   }else{
                    $('li#'+"141>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2016/06/26/java/日志/log4j学习/'>"+ " Log4j学习</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2016/06/26/java/日志/log4j学习/'>"+" Log4j学习</a></li></ul>"
              
                   if($('li#'+"262>ul").length==0){
                    $('li#'+"262").append(chirldHtml);
                   }else{
                    $('li#'+"262>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/12/05/rocketMQ/rocketMQ学习/RocketMQ命令/'>"+ " RocketMQ命令</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/12/05/rocketMQ/rocketMQ学习/RocketMQ命令/'>"+" RocketMQ命令</a></li></ul>"
              
                   if($('li#'+"241>ul").length==0){
                    $('li#'+"241").append(chirldHtml);
                   }else{
                    $('li#'+"241>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/12/12/java/日志/slf4j log4j logback关系详解和相关用法/'>"+ " slf4j log4j logback关系详解和相关用法</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/12/12/java/日志/slf4j log4j logback关系详解和相关用法/'>"+" slf4j log4j logback关系详解和相关用法</a></li></ul>"
              
                   if($('li#'+"262>ul").length==0){
                    $('li#'+"262").append(chirldHtml);
                   }else{
                    $('li#'+"262>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/12/04/rocketMQ/rocketMQ学习/十分钟入门RocketMQ/'>"+ " 十分钟入门RocketMQ</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/12/04/rocketMQ/rocketMQ学习/十分钟入门RocketMQ/'>"+" 十分钟入门RocketMQ</a></li></ul>"
              
                   if($('li#'+"241>ul").length==0){
                    $('li#'+"241").append(chirldHtml);
                   }else{
                    $('li#'+"241>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/05/git&github/github/github项目排名/'>"+ " github项目排名</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/05/git&github/github/github项目排名/'>"+" github项目排名</a></li></ul>"
              
                   if($('li#'+"52>ul").length==0){
                    $('li#'+"52").append(chirldHtml);
                   }else{
                    $('li#'+"52>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/12/11/rocketMQ/rocketMQ学习/消息ACK机制及消费进度管理/'>"+ " 消息ACK机制及消费进度管理</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/12/11/rocketMQ/rocketMQ学习/消息ACK机制及消费进度管理/'>"+" 消息ACK机制及消费进度管理</a></li></ul>"
              
                   if($('li#'+"241>ul").length==0){
                    $('li#'+"241").append(chirldHtml);
                   }else{
                    $('li#'+"241>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/10/17/spring&springMvc/springMVC/ContextLoaderListener And DispatcherServlet Concepts/'>"+ " ContextLoaderListener And DispatcherServlet Concepts</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/10/17/spring&springMvc/springMVC/ContextLoaderListener And DispatcherServlet Concepts/'>"+" ContextLoaderListener And DispatcherServlet Concepts</a></li></ul>"
              
                   if($('li#'+"102>ul").length==0){
                    $('li#'+"102").append(chirldHtml);
                   }else{
                    $('li#'+"102>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2016/06/26/java/日志/log4j例子/'>"+ " Log4j例子</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2016/06/26/java/日志/log4j例子/'>"+" Log4j例子</a></li></ul>"
              
                   if($('li#'+"262>ul").length==0){
                    $('li#'+"262").append(chirldHtml);
                   }else{
                    $('li#'+"262>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/25/spring&springMvc/spring/BeanPostProcessor/'>"+ " BeanPostProcessor</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/25/spring&springMvc/spring/BeanPostProcessor/'>"+" BeanPostProcessor</a></li></ul>"
              
                   if($('li#'+"101>ul").length==0){
                    $('li#'+"101").append(chirldHtml);
                   }else{
                    $('li#'+"101>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/12/04/spring&springMvc/spring/Environment abstraction/'>"+ " Environment abstraction</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/12/04/spring&springMvc/spring/Environment abstraction/'>"+" Environment abstraction</a></li></ul>"
              
                   if($('li#'+"101>ul").length==0){
                    $('li#'+"101").append(chirldHtml);
                   }else{
                    $('li#'+"101>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/12/04/rocketMQ/rocketMQ学习/RocketMQ基础/'>"+ " RocketMQ开发指南</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/12/04/rocketMQ/rocketMQ学习/RocketMQ基础/'>"+" RocketMQ开发指南</a></li></ul>"
              
                   if($('li#'+"241>ul").length==0){
                    $('li#'+"241").append(chirldHtml);
                   }else{
                    $('li#'+"241>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/11/07/spring&springMvc/spring/How to use the Spring FactoryBean/'>"+ " How to use the Spring FactoryBean</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/11/07/spring&springMvc/spring/How to use the Spring FactoryBean/'>"+" How to use the Spring FactoryBean</a></li></ul>"
              
                   if($('li#'+"101>ul").length==0){
                    $('li#'+"101").append(chirldHtml);
                   }else{
                    $('li#'+"101>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/06/spring&springMvc/springMVC/Exception/'>"+ " Exception Handling in Spring MVC</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/06/spring&springMvc/springMVC/Exception/'>"+" Exception Handling in Spring MVC</a></li></ul>"
              
                   if($('li#'+"102>ul").length==0){
                    $('li#'+"102").append(chirldHtml);
                   }else{
                    $('li#'+"102>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/11/30/spring&springMvc/spring/基于Java的容器配置/'>"+ " 基于Java的容器配置</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/11/30/spring&springMvc/spring/基于Java的容器配置/'>"+" 基于Java的容器配置</a></li></ul>"
              
                   if($('li#'+"101>ul").length==0){
                    $('li#'+"101").append(chirldHtml);
                   }else{
                    $('li#'+"101>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/12/14/springBoot/springboot学习/Spring Boot 默认日志logback配置解析/'>"+ " springBoot默认日志logback配置解析</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/12/14/springBoot/springboot学习/Spring Boot 默认日志logback配置解析/'>"+" springBoot默认日志logback配置解析</a></li></ul>"
              
                   if($('li#'+"281>ul").length==0){
                    $('li#'+"281").append(chirldHtml);
                   }else{
                    $('li#'+"281>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/25/spring&springMvc/spring/spring-differerce-between-application-context-and-servlet-context/'>"+ " ServletContext与ApplicationContext的区别</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/25/spring&springMvc/spring/spring-differerce-between-application-context-and-servlet-context/'>"+" ServletContext与ApplicationContext的区别</a></li></ul>"
              
                   if($('li#'+"101>ul").length==0){
                    $('li#'+"101").append(chirldHtml);
                   }else{
                    $('li#'+"101>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/13/spring源码/spring/看看Spring的源码 (二)-——bean实例化/'>"+ " 看看Spring的源码(二)——bean实例化</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/13/spring源码/spring/看看Spring的源码 (二)-——bean实例化/'>"+" 看看Spring的源码(二)——bean实例化</a></li></ul>"
              
                   if($('li#'+"121>ul").length==0){
                    $('li#'+"121").append(chirldHtml);
                   }else{
                    $('li#'+"121>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/09/13/spring源码/spring/看看Spring的源码 (一)——Bean加载过程/'>"+ " 看看Spring的源码 (一)——Bean加载过程</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/09/13/spring源码/spring/看看Spring的源码 (一)——Bean加载过程/'>"+" 看看Spring的源码 (一)——Bean加载过程</a></li></ul>"
              
                   if($('li#'+"121>ul").length==0){
                    $('li#'+"121").append(chirldHtml);
                   }else{
                    $('li#'+"121>ul:first").append(html);
                   }

              
            
              var html="<li>" +"<a href='/2017/11/20/springBoot/springboot学习/Spring Boot的启动器Starter详解/'>"+ " Spring Boot的启动器Starter详解</a></li>";
              var chirldHtml="<ul><li>"+"<a href='/2017/11/20/springBoot/springboot学习/Spring Boot的启动器Starter详解/'>"+" Spring Boot的启动器Starter详解</a></li></ul>"
              
                   if($('li#'+"281>ul").length==0){
                    $('li#'+"281").append(chirldHtml);
                   }else{
                    $('li#'+"281>ul:first").append(html);
                   }

              
            

            $('#mmenu').mmenu({
             extensions		: [ 'widescreen', 'theme-white', 'effect-menu-slide', 'pagedim-black','pageshadow'],
             			counters		: true,
             			dividers		: {
             				fixed 	: true
             			},
             			navbar 			: {
             				title	: 'blog-catalog'
             			},
             			navbars			: [{
             				position: 'top',
             				content : ['searchfield']
             			}, {
             				position: 'top'
             			}, {
             				position: 'bottom',
             				content : ['<div>Hosted by <a href="http://damonflycloud.info" target="_blank">FlyCloud</a></div>']
             			}]
            });
          });

          
      $("table").wrap("<div class='table-area'></div>");


       /**$(".donate-btn").hover(function () {
        $('#sidebar').css('display','block');
        $('.header-inner').css('display','inherit');
       $('.sidebar-inner').css('display','inherit');
        });

         $('#hamburger').click(function(){
         $('.sidebar').css('display','none');
          $('#mm-blocker').on("click",function(){
          $('.sidebar').css('display','block');
        })
       });**/
       
       

      });
</script>



  


  




	





  





  





  






  





  

  

  

  

  
 

</body>

 

</html>
